<html>
<head>
    <meta charset="utf-8">
    <title>Form</title>
    <!-- Následují zdroje použité pro tvorbu formuláře a validátorů-->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/css/bootstrapValidator.min.css" />
    <link rel="stylesheet" href="/datepicker/css/datepicker.css" />
    <style type="text/css">
        body {
            padding: 2em;
        }
        legend.panel-title {
            border: 0;
            margin: 0;
            font-size: inherit;
        }
        .has-feedback .form-control-feedback {
            top: 25px !important;
        }
    </style>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/js/bootstrapValidator.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/lang/cs.min.js"></script>
    <script type="text/javascript" src="/datepicker/js/datepicker.js"></script>
    <!-- Konec zdrojů-->
</head>
<body>
    <!-- Měření zobrazení formuláře - obsahuje název formuláře, stav a žádné chyby-->
    <script type="text/javascript">
        var measure = {
            form: 'test_form', // Název formuláře
            status: 'view', // Informace, že jde o zobrazení
            errors: [] // Při zobrazení nejsou žádné chyby
        }
        // Následovalo by odeslání dat z data layeru do konkrétního analytického software
    </script>
    <!-- Konec měření zobrazení formuláře-->
    <h1>Form</h1>
    <!-- Html definice formulářových prvků-->
    <form id="form" method="get" action="/">
        <fieldset class="panel panel-default">
            <div class="panel-heading">
                <legend class="panel-title">Specific formats</legend>
            </div>
            <div class="panel-body container-fluid">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Text*</label>
                            <input type="text" class="form-control" name="text" />
                            <span class="help-block">6-30 characters long, alphabetical, number, underscore, not empty (e.g. 123_ab), not empty</span>
                        </div>
                        <div class="form-group">
                            <label>Email address</label>
                            <input type="text" class="form-control" name="email" />
                            <span class="help-block">Email in valid format, not empty (e.g. t@e.st)</span>
                        </div>
                        <div class="form-group">
                            <label>Phone number</label>
                            <input type="text" class="form-control" name="telephone" />
                            <span class="help-block">Valid czech phone number format - nine digits with optional country code +420, not empty (e.g. +420 123 456 789)</span>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <div class="input-group date" id="datepicker">
                                <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                                <input type="text" class="form-control" name="datum" required data-provide="datepicker" data-date-format="DD.MM.YYYY" />
                            </div>
                            <span class="help-block">Date in DD.MM.YYYY format (e.g. 01.01.2001)</span>
                        </div>
                        <script type="text/javascript">
                            $(function () {
                                $('#datepicker').datetimepicker({
                                    language: 'cs',
                                    pickTime: false
                                });
                            });
                        </script>
                        <div class="form-group">
                            <label>Bank account number:</label>
                            <input type="text" class="form-control" name="cisloUctu" />
                            <span class="help-block">Not empty, 2-10 digits, valid format (e.g. 123)</span>
                        </div>        
                    </div>        
                    <div class="col-md-6">
                    </div>        
                </div>        
            </div>
        </fieldset>
        <div class="form-group">
            <label>Choose two or three:</label>
            <div class="checkbox">
                <label>
                    <input type="checkbox" name="checkboxes[]" value="1" /> First
                </label>
            </div>
            <div class="checkbox">
                <label>
                    <input type="checkbox" name="checkboxes[]" value="2" /> Second
                </label>
            </div>
            <div class="checkbox">
                <label>
                    <input type="checkbox" name="checkboxes[]" value="3" /> Third
                </label>
            </div>
            <div class="checkbox">
                <label>
                    <input type="checkbox" name="checkboxes[]" value="4" /> Fourth
                </label>
            </div>
            <div class="checkbox">
                <label>
                    <input type="checkbox" name="checkboxes[]" value="5" /> Fifth
                </label>
            </div>
            <span class="help-block">No more, no less (e.g. First, Third)</span>
        </div>
        <div>
            <span class="help-block">Fill in at least 2 of 3:</span>
        </div>
        <div class="form-group">
            <label>Input minimum</label>
            <input type="text" class="form-control" name="minCislo" />
            <span class="help-block">Only number, greater than 0, lesser than maximum</span>
        </div>
        <div class="form-group">
            <label>Input maximum</label>
            <input type="text" class="form-control" name="maxCislo" />
            <span class="help-block">Only number, lesser than or equal to maximum, greater than or equal to minimum</span>
        </div>
        <div class="form-group">
            <label>Input number between them</label>
            <input type="text" class="form-control" name="cislo" />
            <span class="help-block">Only number, greater than minimum</span>
        </div>        
        <input type="submit" class="btn btn-primary" value="Submit">
    </form>
    <!-- Konec definice prvků formuláře-->
    <script type="text/javascript">
        function checkGlobalErrors() { // Validace chyb, které nejdou implementovat prostřednictvím bootstrap validátorů (např. proto, že se nevztahují ke konkrétnímu poli)
            if ((document.getElementsByName('text')[0].value == "") && (document.getElementsByName('email')[0].value == "") && (document.getElementsByName('telephone')[0].value == "") && (document.getElementsByName('checkboxes[]')[0].checked == false) && (document.getElementsByName('checkboxes[]')[1].checked == false) && (document.getElementsByName('checkboxes[]')[2].checked == false) && (document.getElementsByName('checkboxes[]')[3].checked == false) && (document.getElementsByName('checkboxes[]')[4].checked == false) && (document.getElementsByName('datum')[0].value == "") && (document.getElementsByName('minCislo')[0].value == "") && (document.getElementsByName('maxCislo')[0].value == "") && (document.getElementsByName('cislo')[0].value == "") && (document.getElementsByName('cisloUctu')[0].value == "")) { // celý formulář je prázdný
                measure.errors = []; // Odstraní jednotlivé změřené chyby (budou nahrazeny jednou souhrnou)
                // Přidá do měření chybu "formulář je prázdný"
                measure.errors.push({
                    fieldName: 'test_form',
                    errorType: 'empty',
                    fieldValue: ''
                });
                return false;
            } else { // tj. některý prvek formuláře je vyplněný - ověřuji dále
                var mnoz = [((document.getElementsByName('minCislo')[0].value != "") === true ? 1 : 0), ((document.getElementsByName('maxCislo')[0].value != "") === true ? 1 : 0), ((document.getElementsByName('cislo')[0].value != "") === true ? 1 : 0)];
                if ((mnoz[0] + mnoz[1] + mnoz[2]) > 1) { // vyplněné aspoň dvě ze tří polí min/max/between
                    return true;
                } else { // vyplněno 1 nebo 0 polí
                    //Přidá do měření chybu "vyplněno málo polí" a informaci (string), která pole byla a nebyla vyplněna
                    measure.errors.push({
                        fieldName: 'trojice_cisel',
                        errorType: 'malo_vyplnenych',
                        fieldValue: mnoz.toString()
                    });
                    return false;
                }
            }
        }

        // Následují prvky bootstrap validátoru
        $(document).ready(function() {
            $('#form').bootstrapValidator({
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                live: 'disabled', // Validace probíhá až při odeslání
                fields: {
                // Následují validátory, prvek po prvku (dle name parametru), validátory jsou definované v knihovně bootsrap validátoru, zde se jen zadávají jejich parametry
                    text: {
                        validators: {
                            notEmpty: {
                                message: 'The text is required and cannot be empty'
                            },
                            stringLength: {
                                min: 6,
                                max: 30,
                                message: 'The text must be more than 6 and less than 30 characters long'
                            },
                            regexp: {
                                regexp: /^[a-zA-Z0-9_]+$/,
                                message: 'The text can only consist of alphabetical, number and underscore'
                            }
                        }
                    },
                    email: {
                        validators: {
                            notEmpty: {
                                message: 'The email is required and cannot be empty'
                             },
                            emailAddress: {
                                message: 'The input is not a valid email address'
                            }
                        }
                    },
                    telephone: {
                        validators: {
                             notEmpty: {
                                 message: 'The phone number is required and cannot be empty'
                             },
                            // phone validace není udělaná pro ČR, proto regexp
                            regexp: {
                                regexp: /^(\+420|00420)?[0-9]{9}$/,
                                message: 'The input is not a valid phone number'
                            }
                        }
                    },
                    'checkboxes[]': {
                        validators: {
                            choice: {
                                min: 2,
                                max: 3,
                                message: 'Choose 2-3 items' 
                            }
                        }
                    },
                    datum: {
                        validators: {
                            date: {
                                format: 'DD.MM.YYYY',
                                separator: '.',
                                message: 'The value is not a valid date'
                            }
                        }
                    },
                    minCislo: {
                        validators: {
                            numeric: {
                                separator: ',',
                                message: 'The value is not a valid number'
                            },
                            greaterThan: {
                                inclusive: 'true',
                                value: 0,
                                message: 'The number must be greter than 0'
                            },
                            lessThan: {
                                inclusive: 'true',
                                value: 'maxCislo',
                                message: 'The number must be lesser than maximum'
                            }
                        }
                    },
                    maxCislo: {
                        validators: {
                            numeric: {
                                separator: ',',
                                message: 'The value is not a valid number'
                            },
                            greaterThan: {
                                inclusive: 'true',
                                value: 'minCislo',
                                message: 'The number must be greter than minimum'
                            }
                        }
                    },
                    cislo: {
                        validators: {
                            numeric: {
                                separator: ',',
                                message: 'The value is not a valid number'
                            },
                            between: {
                                min: 'minCislo',
                                max: 'maxCislo',
                                message: 'The number must be between minimum and maximum'
                            }
                        }
                    },
                    cisloUctu: {
                        validators: {
//                             digits: {
//                                 message: 'The value is not a valid number'
//                             },
//                             stringLength: {
//                                 min: 2,
//                                 max: 10,
//                                 message: 'Account number has to be 2-10 digits long'
//                             },
                            callback: {
                                message: 'Invalid account number',
                                callback: function(value) {
                                    if ((value == "") || (value == 0)) {
                                        return false;
                                    } else {
                                        var n = value.length;
                                        var vahy = [6, 3, 7, 9, 10, 5, 8, 4, 2, 1];
                                        var souc = 0;
                                        for (i = n - 1; i >= 0; i--) {
                                            souc = souc + parseInt(value.charAt(i)) * vahy[10 - n + i];
                                        }
                                        return (souc % 11) == 0;
                                    }
                                } // Vrátí-li callback hodnotu true, tak se .on(success.form.bv,...) případně .on(error.form.bv,...) provedou dvakrát - nevím, čím je to způsobeno a jak tomu rozumně zamezit, zřejmě jde o chybu bootsrap validatoru 
                            }
                        }
                    }
                }
            }) // Konec definic validátorů
            .on('error.validator.bv', function(e, data) { // Vždy, když nějaký validátor zahlásí chybnou validaci
                var value;
                switch (data.field) { // Dle prvku, ve kterém je chyba, se určí co znamená "hodnota, která je chybně" (zde je to vždy string)
                    case 'checkboxes[]':
                        var fields = document.getElementsByName('checkboxes[]'),
                            values = []; // Seznam checkboxů
                        for (var i = 0; i < fields.length; ++i) {
                            if (fields[i].checked) {
                                values.push(fields[i].value);
                            }
                        }
                        value = values.join(',');
                        break;
                    case 'cislo':
                        switch (data.validator) {
                            case 'between':
                                value = data.element[0].value + "|" + document.getElementsByName('minCislo')[0].value + "-" + document.getElementsByName('maxCislo')[0].value; // Chybná hodnota a meze, ze kterých vybočila
                                break;
                            default:
                                value = data.element[0].value;
                        }
                        break;
                    case 'minCislo':
                        switch (data.validator) {
                            case 'lessThan':
                                var value = data.element[0].value + "<" + document.getElementsByName('maxCislo')[0].value; // Chybná hodnota a mez, kterou překročila
                                break;
                            default:
                                value = data.element[0].value;
                        }
                        break;
                    case 'maxCislo':
                        switch (data.validator) {
                            case 'greaterThan':
                                value = data.element[0].value + ">" + document.getElementsByName('minCislo')[0].value; // Chybná hodnota a mez, které nedosáhla
                                break;
                            default:
                                value = data.element[0].value;
                        }
                        break;
                    default:
                        value = data.element[0].value; // Defaultně je to value vyplněného prvku
                }
                measure.errors.push({
                    fieldName: data.field,
                    errorType: data.validator,
                    fieldValue: value
                });
            })
            .on('error.form.bv', function(event) { // Pokud některý validátor zahlásil chybu
                event.preventDefault();
                checkGlobalErrors(); // Ověření kritérií, která se neověřují validátorem
                measure.status = 'fail'; // Nastavení stavu formuláře
                // Následovalo by odeslání dat z data layeru do konkrétního analytického software
                console.log(measure.errors);
                measure.errors = []; // Vymazání záznamů o chybách, aby nedocházelo k duplikaci, pro lepší názornost výsledků nyní zakomentováno
            })
            .on('success.form.bv', function(event) { // Pokud žádný validátor nehlásí chybu
                event.preventDefault();
                var OK = checkGlobalErrors(); // Ověření kritérií, která se neověřují validátorem
                if (OK) { // Pokud nejsou žádné chyby
                    measure.status = 'success';
                    // Následovalo by odeslání dat z data layeru do konkrétního analytického software
                    console.log(measure);
                } else { // Pokud jsou nějaké chyby
                    measure.status = 'fail';
                    // Následovalo by odeslání dat z data layeru do konkrétního analytického software
                    console.log(measure.errors);
                    measure.errors = []; // Vymazání záznamů o chybách, aby nedocházelo k duplikaci, pro lepší názornost výsledků nyní zakomentováno
                }
            })
        });
    </script>
</body>
</html>